<head>
    <link rel="stylesheet" href="https://bootswatch.com/5/cosmo/bootstrap.min.css">
    <link rel="stylesheet" href="../styles/mystyles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" type="text/css" rel="stylesheet" />
    <script type=module src="../header.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>



</head>
<style>
    h1 {
        text-align: left;
    }

    div.fact_info {
        text-align: center;
        padding-bottom: 50px;
        padding-top: 25px;
    }
</style>

<body>
    <main-header></main-header>
    <div class="section-container">
        <h1>Gestión de inventario</h1>
    </div>

    <div>
        <!doctype html>
        <title>Upload new File</title>
        <h1>Upload new File</h1>
        <form method=post enctype=multipart/form-data>
            <input type=file name=file>
            <button onclick="getCompras(event)">Suir archivo</button>
        </form>
    </div>
    <p id="dynamic">
    <div class="fact_info" id="myData"></div>
    <div class="container">
        <table id="table_id" class="display">
            <thead id="thead_id">
                <tr>
                    <th id="ID"></th>
                    <th id="nombre"></th>
                    <th id="descripcion"></th>
                    <th id="stock"></th>
                    <th id="precioUnitario"></th>
                </tr>
            </thead>
            <tbody id="data">
            </tbody>
        </table>
    </div>
    </p>
</body>

<script>

    async function Upload() {
        const formData = new FormData();
        const fileField = document.querySelector('input[type="file"]');
        formData.append('file', fileField.files[0]);
        const response = await fetch('http://127.0.0.1:5000/documento', {
            method: 'POST',
            body: formData
        })
        const contentType = response.headers.get("content-type");
        console.log(contentType)
        const compras = await response.json()
        console.log(compras);
        return compras;
    }

    async function getCompras(e) {
        e.preventDefault();
        e.stopPropagation();
        Upload().then(
            data => {
                console.log(data)
                var mainContainer = document.getElementById("myData");
                var temp = "";
                const info = JSON.parse(data.info);
                // const prods = JSON.parse(JSON.parse(data.productos));
                console.log(info);

                //var jsonPretty = JSON.stringify(info, null, 2);
                //mainContainer.innerHTML = "<pre>" + jsonPretty + "</pre>"
                mainContainer.innerHTML = '';
                for (key in info) {
                    if (info.hasOwnProperty(key)) {
                        var div = document.createElement("div");
                        div.innerHTML = key + " : " + info[key];
                        mainContainer.appendChild(div);
                    }
                }


                //const prods = JSON.parse(data.producto); //array
                const prods = JSON.parse(data.productos);
                console.log(prods);
                document.getElementById('ID').innerHTML = "Id";
                document.getElementById('nombre').innerHTML = "Nombre";
                document.getElementById('descripcion').innerHTML = "Descripción";
                document.getElementById('stock').innerHTML = "Stock";
                document.getElementById('precioUnitario').innerHTML = "Precio Unitario";
                if ($.fn.dataTable.isDataTable('#table_id')) {
                    var datatable = $('#table_id').DataTable();
                    datatable.clear();
                    datatable.rows.add(data);
                    datatable.draw();
                }
                else {
                    table = $('#table_id').DataTable({
                        "paging": false,
                        "ordering": false,
                        "info": false,
                        "searching": false,
                        retrieve: true,
                        data: prods,
                        columns: [
                            { data: 'idProducto' },
                            { data: 'nombre' },
                            { editField: 'descripcion' },
                            { data: 'stock' },
                            { data: 'precioUnitario' },
                        ],
                        targets: [1, 2, 3]
                    });
                    $('#table_id').on('click', 'tbody td', function (e) {
                        editor.inline(this);
                    });
                }
            }
        )
    }
</script>